# EtherFlow é¡¹ç›®å…³é”®ä»£ç æ•´ç†

## ç›®å½•
- [é’±åŒ…äº¤äº’](#é’±åŒ…äº¤äº’)
  - [é’±åŒ…è¿æ¥](#é’±åŒ…è¿æ¥)
  - [å¤´åƒä¿¡æ¯è·å–](#å¤´åƒä¿¡æ¯è·å–)
  - [ç½‘ç»œåˆ‡æ¢é€»è¾‘](#ç½‘ç»œåˆ‡æ¢é€»è¾‘)
  - [è·å–ç½‘ç»œé€»è¾‘](#è·å–ç½‘ç»œé€»è¾‘)
  - [å‘èµ·é’±åŒ…è½¬è´¦é€»è¾‘](#å‘èµ·é’±åŒ…è½¬è´¦é€»è¾‘)
  - [è·å–é’±åŒ…ä½™é¢é€»è¾‘](#è·å–é’±åŒ…ä½™é¢é€»è¾‘)
  - [è·å–äº¤æ˜“ä¿¡æ¯é€»è¾‘](#è·å–äº¤æ˜“ä¿¡æ¯é€»è¾‘)
- [åˆçº¦äº¤äº’](#åˆçº¦äº¤äº’)
  - [è·å–åˆçº¦å˜é‡é€»è¾‘](#è·å–åˆçº¦å˜é‡é€»è¾‘)
  - [è·å–åˆçº¦æ—¥å¿—é€»è¾‘](#è·å–åˆçº¦æ—¥å¿—é€»è¾‘)

---

## é’±åŒ…äº¤äº’

### é’±åŒ…è¿æ¥

#### 1. Wagmi æ–¹å¼è¿æ¥é’±åŒ…
**æ–‡ä»¶**: `src/app/components/WalletConnect.tsx`

```typescript
// å¯¼å…¥ wagmi åº“ä¸­çš„é’±åŒ…è¿æ¥ç›¸å…³ hooks
import { useAccount, useConnect, useDisconnect, useBalance, useSendTransaction, useSwitchChain } from 'wagmi'
import { parseEther } from 'viem'

export default function WalletConnect() {
  // useAccount hook - è·å–å½“å‰é’±åŒ…è´¦æˆ·ä¿¡æ¯
  const { 
    address,        // å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€ (string | undefined)
    isConnected,    // é’±åŒ…æ˜¯å¦å·²è¿æ¥ (boolean)
    chain          // å½“å‰è¿æ¥çš„ç½‘ç»œé“¾ä¿¡æ¯ (Chain | undefined)
  } = useAccount()

  // useConnect hook - æä¾›é’±åŒ…è¿æ¥åŠŸèƒ½
  const { 
    connect,        // è¿æ¥é’±åŒ…çš„å‡½æ•°ï¼Œæ¥å—è¿æ¥å™¨å‚æ•°
    connectors,     // å¯ç”¨çš„é’±åŒ…è¿æ¥å™¨åˆ—è¡¨ (Connector[])
    isPending       // è¿æ¥è¿‡ç¨‹æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­ (boolean)
  } = useConnect()

  // useDisconnect hook - æä¾›é’±åŒ…æ–­å¼€è¿æ¥åŠŸèƒ½
  const { 
    disconnect      // æ–­å¼€é’±åŒ…è¿æ¥çš„å‡½æ•°
  } = useDisconnect()

  // useSwitchChain hook - æä¾›ç½‘ç»œåˆ‡æ¢åŠŸèƒ½
  const { 
    switchChain     // åˆ‡æ¢ç½‘ç»œé“¾çš„å‡½æ•°ï¼Œæ¥å—é“¾IDå‚æ•°
  } = useSwitchChain()

  // useBalance hook - è·å–é’±åŒ…ä½™é¢ä¿¡æ¯
  const { 
    data: balance,           // ä½™é¢æ•°æ®å¯¹è±¡ï¼ŒåŒ…å« valueã€formatted ç­‰å±æ€§
    isLoading: balanceLoading, // ä½™é¢åŠ è½½çŠ¶æ€ (boolean)
    error: balanceError,     // ä½™é¢æŸ¥è¯¢é”™è¯¯ä¿¡æ¯
    refetch: refetchBalance  // é‡æ–°è·å–ä½™é¢çš„å‡½æ•°
  } = useBalance({
    address: address,        // è¦æŸ¥è¯¢ä½™é¢çš„åœ°å€
  })

  // è½¬è´¦è¡¨å•çŠ¶æ€ç®¡ç†
  const [toAddress, setToAddress] = useState('')  // æ¥æ”¶æ–¹åœ°å€
  const [amount, setAmount] = useState('')        // è½¬è´¦é‡‘é¢

  // useSendTransaction hook - æä¾›å‘é€äº¤æ˜“åŠŸèƒ½
  const { 
    sendTransaction,              // å‘é€äº¤æ˜“çš„å‡½æ•°
    isPending: isTransferPending, // äº¤æ˜“å‘é€è¿‡ç¨‹ä¸­çš„åŠ è½½çŠ¶æ€
    isSuccess,                   // äº¤æ˜“æ˜¯å¦å‘é€æˆåŠŸ
    error                        // äº¤æ˜“å‘é€è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯
  } = useSendTransaction({
    mutation: {
      onSuccess: () => {
        // è½¬è´¦æˆåŠŸååˆ·æ–°ä½™é¢
        setTimeout(() => {
          refetchBalance()
        }, 2000) // ç­‰å¾…2ç§’è®©äº¤æ˜“ç¡®è®¤
      }
    }
  })

  // å¤„ç†è½¬è´¦çš„å‡½æ•°
  const handleTransfer = () => {
    // æ£€æŸ¥è¾“å…¥æ˜¯å¦å®Œæ•´
    if (!toAddress || !amount) return
    
    // å°†ETHé‡‘é¢è½¬æ¢ä¸ºWeiå•ä½
    const amountInWei = parseEther(amount)
    
    // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    if (balance && amountInWei > balance.value) {
      alert('ä½™é¢ä¸è¶³ï¼')
      return
    }
    
    try {
      // å‘é€äº¤æ˜“
      sendTransaction({
        to: toAddress as `0x${string}`,  // æ¥æ”¶æ–¹åœ°å€ï¼Œç±»å‹æ–­è¨€ä¸º0xå¼€å¤´çš„å­—ç¬¦ä¸²
        value: amountInWei,              // è½¬è´¦é‡‘é¢ï¼ˆWeiå•ä½ï¼‰
      })
    } catch (err) {
      console.error('Transfer failed:', err)
    }
  }

  // æ£€æŸ¥ä½™é¢æ˜¯å¦ä¸è¶³çš„å‡½æ•°
  const isInsufficientBalance = () => {
    if (!balance || !amount) return false
    try {
      const amountInWei = parseEther(amount)
      return amountInWei > balance.value
    } catch {
      return false
    }
  }

  // åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œï¼ˆé“¾ID: 1337ï¼‰
  const switchToLocalhost = () => {
    switchChain({ chainId: 1337 })
  }

  // æ ¼å¼åŒ–ä½™é¢æ˜¾ç¤ºçš„å‡½æ•°
  const formatBalance = (balance: any) => {
    if (!balance) return '0'
    const balanceInEth = Number(balance.value) / 1e18  // å°†Weiè½¬æ¢ä¸ºETH
    return balanceInEth.toFixed(4) // ä¿ç•™4ä½å°æ•°
  }
}
```

#### Wagmi Hooks è¯¦ç»†è¯´æ˜

**useAccount Hook**
- **ä½œç”¨**: è·å–å½“å‰é’±åŒ…è´¦æˆ·çš„çŠ¶æ€ä¿¡æ¯
- **è¿”å›å€¼**:
  - `address`: å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€ï¼Œæ ¼å¼ä¸º `0x...`ï¼Œæœªè¿æ¥æ—¶ä¸º `undefined`
  - `isConnected`: å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºé’±åŒ…æ˜¯å¦å·²æˆåŠŸè¿æ¥
  - `chain`: å½“å‰è¿æ¥çš„ç½‘ç»œé“¾å¯¹è±¡ï¼ŒåŒ…å«é“¾IDã€åç§°ã€RPC URLç­‰ä¿¡æ¯

**useConnect Hook**
- **ä½œç”¨**: æä¾›é’±åŒ…è¿æ¥åŠŸèƒ½å’Œç›¸å…³çŠ¶æ€
- **è¿”å›å€¼**:
  - `connect`: è¿æ¥é’±åŒ…çš„å‡½æ•°ï¼Œéœ€è¦ä¼ å…¥è¿æ¥å™¨å‚æ•°
  - `connectors`: å¯ç”¨çš„é’±åŒ…è¿æ¥å™¨æ•°ç»„ï¼ŒåŒ…æ‹¬ MetaMaskã€WalletConnect ç­‰
  - `isPending`: è¿æ¥è¿‡ç¨‹ä¸­çš„åŠ è½½çŠ¶æ€ï¼Œç”¨äºæ˜¾ç¤ºè¿æ¥ä¸­çš„UI

**useDisconnect Hook**
- **ä½œç”¨**: æä¾›é’±åŒ…æ–­å¼€è¿æ¥åŠŸèƒ½
- **è¿”å›å€¼**:
  - `disconnect`: æ–­å¼€é’±åŒ…è¿æ¥çš„å‡½æ•°ï¼Œè°ƒç”¨åä¼šæ¸…é™¤è¿æ¥çŠ¶æ€

**useSwitchChain Hook**
- **ä½œç”¨**: æä¾›ç½‘ç»œåˆ‡æ¢åŠŸèƒ½
- **è¿”å›å€¼**:
  - `switchChain`: åˆ‡æ¢ç½‘ç»œé“¾çš„å‡½æ•°ï¼Œæ¥å—é“¾IDå‚æ•°

**useBalance Hook**
- **ä½œç”¨**: è·å–é’±åŒ…ä½™é¢ä¿¡æ¯
- **è¿”å›å€¼**:
  - `data`: ä½™é¢æ•°æ®å¯¹è±¡ï¼ŒåŒ…å« valueã€formatted ç­‰å±æ€§
  - `isLoading`: ä½™é¢åŠ è½½çŠ¶æ€
  - `error`: ä½™é¢æŸ¥è¯¢é”™è¯¯ä¿¡æ¯
  - `refetch`: é‡æ–°è·å–ä½™é¢çš„å‡½æ•°

**useSendTransaction Hook**
- **ä½œç”¨**: æä¾›å‘é€äº¤æ˜“åŠŸèƒ½
- **è¿”å›å€¼**:
  - `sendTransaction`: å‘é€äº¤æ˜“çš„å‡½æ•°
  - `isPending`: äº¤æ˜“å‘é€è¿‡ç¨‹ä¸­çš„åŠ è½½çŠ¶æ€
  - `isSuccess`: äº¤æ˜“æ˜¯å¦å‘é€æˆåŠŸ
  - `error`: äº¤æ˜“å‘é€è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯

#### 2. åŸç”Ÿ MetaMask è¿æ¥
**æ–‡ä»¶**: `metamask-connect.html`

```javascript
// æ£€æŸ¥æ˜¯å¦å®‰è£…äº† MetaMask
function checkMetaMask() {
  if (typeof window.ethereum !== 'undefined') {
    return true
  } else {
    alert('è¯·å®‰è£… MetaMask æ’ä»¶')
    return false
  }
}

// è¿æ¥é’±åŒ…
async function connectWallet() {
  if (!checkMetaMask()) return

  try {
    const accounts = await window.ethereum.request({
      method: 'eth_requestAccounts'
    })
    
    if (accounts.length > 0) {
      currentAccount = accounts[0]
      updateUI()
      await getBalance()
    }
  } catch (error) {
    console.error('è¿æ¥å¤±è´¥:', error)
  }
}
```

#### 3. Ethers.js æ–¹å¼è¿æ¥
**æ–‡ä»¶**: `src/app/components/ContractInterface.tsx`

```typescript
import { ethers } from 'ethers'

const connectWallet = async () => {
  try {
    if (typeof window.ethereum !== 'undefined') {
      const provider = new ethers.BrowserProvider(window.ethereum)
      const signer = await provider.getSigner()
      
      setProvider(provider)
      setSigner(signer)
      setIsConnected(true)
      
      await fetchContractState()
    } else {
      console.error('MetaMaskæœªå®‰è£…')
    }
  } catch (error) {
    console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error)
  }
}
```

### å¤´åƒä¿¡æ¯è·å–

#### 1. ENS å¤´åƒè·å–
**æ–‡ä»¶**: `src/app/components/WalletInfo.tsx`

```typescript
import { useEnsName, useEnsAvatar } from 'wagmi'

export default function WalletInfo() {
  const { address } = useAccount()
  const { data: ensName } = useEnsName({ address })
  const { data: ensAvatar } = useEnsAvatar({ name: ensName || undefined })

  // ç”Ÿæˆé»˜è®¤å¤´åƒ
  const generateAvatarUrl = (address: string) => {
    return `https://api.dicebear.com/7.x/identicon/svg?seed=${address}&backgroundColor=f3f4f6&size=32`
  }

  // æ˜¾ç¤ºå¤´åƒ
  <img
    src={ensAvatar || generateAvatarUrl(address)}
    alt="Account Avatar"
    className="w-8 h-8 rounded-full"
    onError={(e) => {
      (e.target as HTMLImageElement).src = generateAvatarUrl(address)
    }}
  />
}
```

#### 2. ENS æµ‹è¯•åŠŸèƒ½
**æ–‡ä»¶**: `src/app/components/EnsTest.tsx`

```typescript
const testEnsLookup = async () => {
  if (!testAddress || !ethers.isAddress(testAddress)) return

  setLoading(true)
  try {
    if (typeof window.ethereum !== 'undefined') {
      const provider = new ethers.BrowserProvider(window.ethereum)
      
      // æŸ¥è¯¢ENSåç§°
      const name = await provider.lookupAddress(testAddress)
      
      // æŸ¥è¯¢ENSå¤´åƒ
      let avatar = null
      if (name) {
        try {
          const resolver = await provider.getResolver(testAddress)
          if (resolver) {
            const avatarResult = await resolver.getAvatar()
            if (avatarResult && typeof avatarResult === 'string') {
              avatar = avatarResult
            } else if (avatarResult && typeof avatarResult === 'object' && (avatarResult as any).url) {
              avatar = (avatarResult as any).url
            }
          }
        } catch (error) {
          console.log('è·å–å¤´åƒå¤±è´¥:', error)
        }
      }

      setEnsResult({ name, avatar })
    }
  } catch (error) {
    console.error('ENSæŸ¥è¯¢å¤±è´¥:', error)
  } finally {
    setLoading(false)
  }
}
```

### ç½‘ç»œåˆ‡æ¢é€»è¾‘

#### 1. Wagmi ç½‘ç»œåˆ‡æ¢
**æ–‡ä»¶**: `src/app/components/UniswapNetworkSelector.tsx`

```typescript
import { useSwitchChain, useChainId } from 'wagmi'
import { mainnet, polygon, arbitrum, optimism, sepolia } from 'wagmi/chains'

export default function UniswapNetworkSelector() {
  const { switchChain } = useSwitchChain()
  const chainId = useChainId()

  const supportedChains = [
    { id: 1337, name: 'Localhost', icon: 'ğŸ ' },
    { id: sepolia.id, name: 'Sepolia', icon: 'ğŸ§ª' },
    { id: mainnet.id, name: 'Ethereum', icon: 'ğŸ”·' },
    { id: polygon.id, name: 'Polygon', icon: 'ğŸŸ£' },
    { id: arbitrum.id, name: 'Arbitrum', icon: 'ğŸ”µ' },
    { id: optimism.id, name: 'Optimism', icon: 'ğŸ”´' },
  ]

  const handleChainSwitch = (chainId: number) => {
    switchChain({ chainId })
    setShowDropdown(false)
  }
}
```

#### 2. ç®€å•ç½‘ç»œåˆ‡æ¢
**æ–‡ä»¶**: `src/app/components/WalletConnect.tsx`

```typescript
const switchToLocalhost = () => {
  switchChain({ chainId: 1337 })
}
```

### è·å–ç½‘ç»œé€»è¾‘

#### 1. è·å–å½“å‰ç½‘ç»œä¿¡æ¯
**æ–‡ä»¶**: `src/app/components/WalletInfo.tsx`

```typescript
import { useChainId } from 'wagmi'

export default function WalletInfo() {
  const chainId = useChainId()
  
  const supportedChains = [
    { ...mainnet, icon: 'ğŸ”·' },
    { ...polygon, icon: 'ğŸŸ£' },
    { ...arbitrum, icon: 'ğŸ”µ' },
    { ...optimism, icon: 'ğŸ”´' },
  ]

  const currentChain = supportedChains.find(chain => chain.id === chainId) || supportedChains[0]
}
```

#### 2. ç›‘å¬ç½‘ç»œå˜åŒ–
**æ–‡ä»¶**: `metamask-connect.html`

```javascript
// ç›‘å¬ç½‘ç»œå˜åŒ–
if (typeof window.ethereum !== 'undefined') {
  window.ethereum.on('chainChanged', function (chainId) {
    console.log('ç½‘ç»œå·²åˆ‡æ¢åˆ°:', chainId)
    if (currentAccount) {
      getBalance()
    }
  })
}
```

### å‘èµ·é’±åŒ…è½¬è´¦é€»è¾‘

#### 1. Wagmi è½¬è´¦
**æ–‡ä»¶**: `src/app/components/WalletConnect.tsx`

```typescript
import { useSendTransaction } from 'wagmi'
import { parseEther } from 'viem'

export default function WalletConnect() {
  const { sendTransaction, isPending: isTransferPending, isSuccess, error } = useSendTransaction({
    mutation: {
      onSuccess: () => {
        // è½¬è´¦æˆåŠŸååˆ·æ–°ä½™é¢
        setTimeout(() => {
          refetchBalance()
        }, 2000)
      }
    }
  })

  const handleTransfer = () => {
    if (!toAddress || !amount) return
    
    const amountInWei = parseEther(amount)
    if (balance && amountInWei > balance.value) {
      alert('ä½™é¢ä¸è¶³ï¼')
      return
    }
    
    try {
      sendTransaction({
        to: toAddress as `0x${string}`,
        value: amountInWei,
      })
    } catch (err) {
      console.error('Transfer failed:', err)
    }
  }
}
```

#### 2. Ethers.js è½¬è´¦
**æ–‡ä»¶**: `src/app/components/ContractInterface.tsx`

```typescript
const handleTransfer = async () => {
  if (!signer || !ethers.isAddress(transferData.to) || !transferData.amount) {
    return
  }

  setLoading(true)
  try {
    const amountWei = ethers.parseEther(transferData.amount)
    const tx = await signer.sendTransaction({
      to: transferData.to,
      value: amountWei
    })
    
    await tx.wait()
    setTransferData({ to: '', amount: '' })
    setOperationStatus({ type: 'success', message: 'è½¬è´¦æˆåŠŸ' })
  } catch (error) {
    console.error('è½¬è´¦å¤±è´¥:', error)
    setOperationStatus({ type: 'error', message: 'è½¬è´¦å¤±è´¥' })
  } finally {
    setLoading(false)
  }
}
```

### è·å–é’±åŒ…ä½™é¢é€»è¾‘

#### 1. Wagmi ä½™é¢æŸ¥è¯¢
**æ–‡ä»¶**: `src/app/components/WalletConnect.tsx`

```typescript
import { useBalance } from 'wagmi'

export default function WalletConnect() {
  const { data: balance, isLoading: balanceLoading, error: balanceError, refetch: refetchBalance } = useBalance({
    address: address,
  })

  const formatBalance = (balance: any) => {
    if (!balance) return '0'
    const balanceInEth = Number(balance.value) / 1e18
    return balanceInEth.toFixed(4)
  }
}
```

#### 2. åŸç”Ÿ MetaMask ä½™é¢æŸ¥è¯¢
**æ–‡ä»¶**: `metamask-connect.html`

```javascript
// è·å–ä½™é¢
async function getBalance() {
  if (!currentAccount) return

  try {
    const balance = await window.ethereum.request({
      method: 'eth_getBalance',
      params: [currentAccount, 'latest']
    })
    
    const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18)
    document.getElementById('accountBalance').textContent = balanceInEth.toFixed(4)
  } catch (error) {
    console.error('è·å–ä½™é¢å¤±è´¥:', error)
  }
}
```

### è·å–äº¤æ˜“ä¿¡æ¯é€»è¾‘

#### 1. äº¤æ˜“æŸ¥è¯¢åŠŸèƒ½
**æ–‡ä»¶**: `src/app/components/ContractInterface.tsx`

```typescript
interface ITransactionData {
  hash: string
  from: string
  to: string
  value: string
  gasPrice: string
  gasLimit: string
  nonce: number
  data: string
  blockNumber: number
  blockHash: string
  timestamp: number
  confirmations: number | (() => Promise<number>)
  status: number
}

const handleQueryTransaction = async () => {
  if (!provider || !transactionHash.trim()) {
    setTransactionError('è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“å“ˆå¸Œ')
    return
  }

  setTransactionLoading(true)
  setTransactionError('')
  setTransactionData(null)

  try {
    // éªŒè¯äº¤æ˜“å“ˆå¸Œæ ¼å¼
    if (!/^0x([A-Fa-f0-9]{64})$/.test(transactionHash)) {
      throw new Error('æ— æ•ˆçš„äº¤æ˜“å“ˆå¸Œæ ¼å¼')
    }

    // è·å–äº¤æ˜“æ”¶æ®
    const receipt = await provider.getTransactionReceipt(transactionHash)
    if (!receipt) {
      throw new Error('äº¤æ˜“ä¸å­˜åœ¨æˆ–å°šæœªè¢«æ‰“åŒ…')
    }

    // è·å–äº¤æ˜“è¯¦æƒ…
    const tx = await provider.getTransaction(transactionHash)
    if (!tx) {
      throw new Error('æ— æ³•è·å–äº¤æ˜“è¯¦æƒ…')
    }

    // è·å–åŒºå—ä¿¡æ¯
    const block = await provider.getBlock(receipt.blockNumber!)
    
    // æ ¼å¼åŒ–äº¤æ˜“æ•°æ®
    const formattedData: ITransactionData = {
      hash: tx.hash,
      from: tx.from,
      to: tx.to || '',
      value: ethers.formatEther(tx.value),
      gasPrice: ethers.formatUnits(tx.gasPrice || 0, 'gwei'),
      gasLimit: tx.gasLimit?.toString() || '0',
      nonce: tx.nonce,
      data: tx.data,
      blockNumber: receipt.blockNumber!,
      blockHash: receipt.blockHash,
      timestamp: block?.timestamp || 0,
      confirmations: typeof receipt.confirmations === 'function' ? await receipt.confirmations() : receipt.confirmations,
      status: receipt.status || 0
    }

    setTransactionData(formattedData)
  } catch (error) {
    console.error('æŸ¥è¯¢äº¤æ˜“å¤±è´¥:', error)
    setTransactionError(error instanceof Error ? error.message : 'æŸ¥è¯¢å¤±è´¥')
  } finally {
    setTransactionLoading(false)
  }
}
```

#### 2. ç‹¬ç«‹äº¤æ˜“æŸ¥è¯¢è„šæœ¬
**æ–‡ä»¶**: `demo-transaction-query.js`

```javascript
async function queryTransaction(txHash, rpcUrl = 'https://eth.llamarpc.com') {
  try {
    console.log('ğŸ” å¼€å§‹æŸ¥è¯¢äº¤æ˜“:', txHash)
    
    // åˆ›å»ºprovider
    const provider = new ethers.JsonRpcProvider(rpcUrl)
    
    // éªŒè¯äº¤æ˜“å“ˆå¸Œæ ¼å¼
    if (!/^0x([A-Fa-f0-9]{64})$/.test(txHash)) {
      throw new Error('æ— æ•ˆçš„äº¤æ˜“å“ˆå¸Œæ ¼å¼')
    }
    
    // è·å–äº¤æ˜“æ”¶æ®
    const receipt = await provider.getTransactionReceipt(txHash)
    if (!receipt) {
      throw new Error('äº¤æ˜“ä¸å­˜åœ¨æˆ–å°šæœªè¢«æ‰“åŒ…')
    }
    
    // è·å–äº¤æ˜“è¯¦æƒ…
    const tx = await provider.getTransaction(txHash)
    if (!tx) {
      throw new Error('æ— æ³•è·å–äº¤æ˜“è¯¦æƒ…')
    }
    
    // è·å–åŒºå—ä¿¡æ¯
    const block = await provider.getBlock(receipt.blockNumber)
    
    // æ ¼å¼åŒ–äº¤æ˜“æ•°æ®
    const transactionData = {
      hash: tx.hash,
      from: tx.from,
      to: tx.to || 'åˆçº¦è°ƒç”¨',
      value: ethers.formatEther(tx.value),
      gasPrice: ethers.formatUnits(tx.gasPrice || 0, 'gwei'),
      gasLimit: tx.gasLimit?.toString() || '0',
      nonce: tx.nonce,
      data: tx.data,
      blockNumber: receipt.blockNumber,
      blockHash: receipt.blockHash,
      timestamp: block?.timestamp || 0,
      confirmations: receipt.confirmations,
      status: receipt.status === 1 ? 'æˆåŠŸ' : 'å¤±è´¥'
    }
    
    console.log('ğŸ‰ äº¤æ˜“æŸ¥è¯¢æˆåŠŸ!')
    console.log(JSON.stringify(transactionData, null, 2))
    
    return transactionData
  } catch (error) {
    console.error('âŒ äº¤æ˜“æŸ¥è¯¢å¤±è´¥:', error.message)
    throw error
  }
}
```

---

## åˆçº¦äº¤äº’

contract å¯¹è±¡åŒ…å«äº†æ™ºèƒ½åˆçº¦çš„æ‰€æœ‰å…¬å¼€æ¥å£

### è·å–åˆçº¦å˜é‡é€»è¾‘

#### 1. åˆçº¦çŠ¶æ€è·å–
**æ–‡ä»¶**: `src/app/components/ContractInterface.tsx`

```typescript
// è·å–åˆçº¦çŠ¶æ€
const fetchContractState = async () => {
  if (!contract) return
  
  try {
    const [messageResult, countResult, ownerResult] = await Promise.all([
      contract.getMessage(),
      contract.getCount(),
      contract.getOwner()
    ])
    
    setMessage(messageResult)
    setCount(Number(countResult))
    setOwner(ownerResult)
    
    // åŒæ—¶åˆ·æ–°åˆçº¦äº‹ä»¶
    contractEventsRef.current?.refresh()
  } catch (error) {
    console.error('è·å–åˆçº¦çŠ¶æ€å¤±è´¥:', error)
    // è®¾ç½®é»˜è®¤å€¼ï¼Œé¿å…æ˜¾ç¤ºç©ºç™½
    setMessage('åˆçº¦æœªè¿æ¥æˆ–åœ°å€é”™è¯¯')
    setCount(0)
    setOwner('æœªçŸ¥')
  }
}
```

#### 2. Wagmi åˆçº¦è¯»å–
**æ–‡ä»¶**: `src/app/components/RedPacketGrabbing.tsx`

```typescript
import { useReadContract } from 'wagmi'

const contractAbi = [
  {
    name: 'totalAmount',
    type: 'function',
    stateMutability: 'view',
    inputs: [],
    outputs: [{ type: 'uint256' }],
  },
  {
    name: 'count',
    type: 'function',
    stateMutability: 'view',
    inputs: [],
    outputs: [{ type: 'uint256' }],
  },
  {
    name: 'isEqual',
    type: 'function',
    stateMutability: 'view',
    inputs: [],
    outputs: [{ type: 'bool' }],
  },
  {
    name: 'isGrabbed',
    type: 'function',
    stateMutability: 'view',
    inputs: [{ type: 'address' }],
    outputs: [{ type: 'uint256' }],
  },
] as const

const { data: totalAmount } = useReadContract({
  address: contractAddress as `0x${string}`,
  abi: contractAbi,
  functionName: 'totalAmount',
})

const { data: count } = useReadContract({
  address: contractAddress as `0x${string}`,
  abi: contractAbi,
  functionName: 'count',
})

const { data: isEqual } = useReadContract({
  address: contractAddress as `0x${string}`,
  abi: contractAbi,
  functionName: 'isEqual',
})
```

#### 3. åˆçº¦é…ç½®
**æ–‡ä»¶**: `src/app/config/contract.ts`

```typescript
export const CONTRACT_CONFIG = {
  // åˆçº¦åœ°å€
  address: process.env.NEXT_PUBLIC_CONTRACT_ADDRESS || '0x23C1684494DaBE62458154757301bD86B46DaCa5',
  
  // åˆçº¦ABI
  abi: [
    {
      "inputs": [],
      "name": "getCount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getMessage",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getOwner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]
}
```

### è·å–åˆçº¦æ—¥å¿—é€»è¾‘

#### 1. åˆçº¦äº‹ä»¶æŸ¥è¯¢ç»„ä»¶
**æ–‡ä»¶**: `src/app/components/ContractEvents.tsx`

```typescript
interface IEventData {
  countIncremented: ICountIncrementedEvent[]
  messageUpdated: IMessageUpdatedEvent[]
}

const ContractEvents = forwardRef<IContractEventsRef, IContractEventsProps>(({ 
  contractAddress = ''
}, ref) => {
  const [events, setEvents] = useState<IEventData>({
    countIncremented: [],
    messageUpdated: []
  })
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  const GRAPH_ENDPOINT = 'https://api.studio.thegraph.com/query/119874/tx/v0.0.2'

  // æŸ¥è¯¢åˆçº¦äº‹ä»¶
  const fetchContractEvents = async (address: string) => {
    if (!address.trim()) {
      setError('è¯·è¾“å…¥åˆçº¦åœ°å€')
      return
    }

    setLoading(true)
    setError('')

    try {
      const query = `
        {
          countIncrementeds(first: 5) {
            id
            newCount
            blockNumber
            blockTimestamp
          }
          messageUpdateds(first: 5) {
            id
            newMessage
            updatedBy
            blockNumber
          }
        }
      `

      const response = await fetch(GRAPH_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query })
      })
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }

      const data = await response.json()

      if (data.errors) {
        throw new Error(data.errors[0]?.message || 'GraphQLæŸ¥è¯¢é”™è¯¯')
      }

      setEvents({
        countIncremented: data.data?.countIncrementeds || [],
        messageUpdated: data.data?.messageUpdateds || []
      })

      setLastQueryTime(new Date())
    } catch (err) {
      console.error('æŸ¥è¯¢åˆçº¦äº‹ä»¶å¤±è´¥:', err)
      setError(err instanceof Error ? err.message : 'æŸ¥è¯¢å¤±è´¥')
    } finally {
      setLoading(false)
    }
  }

  // åˆ·æ–°äº‹ä»¶
  const handleRefresh = () => {
    if (contractAddress.trim()) {
      fetchContractEvents(contractAddress)
    }
  }

  // æš´éœ²åˆ·æ–°æ–¹æ³•ç»™çˆ¶ç»„ä»¶
  useImperativeHandle(ref, () => ({
    refresh: handleRefresh
  }))
}
```

#### 2. äº‹ä»¶æ•°æ®ç»“æ„
**æ–‡ä»¶**: `src/app/components/ContractEvents.tsx`

```typescript
interface ICountIncrementedEvent {
  id: string
  newCount: string
  blockNumber: string
  blockTimestamp: string
  transactionHash: string
}

interface IMessageUpdatedEvent {
  id: string
  newMessage: string
  updatedBy: string
  blockNumber: string
  blockTimestamp: string
  transactionHash: string
}
```

#### 3. åˆçº¦äº‹ä»¶ ABI å®šä¹‰
**æ–‡ä»¶**: `src/app/config/contract.ts`

```typescript
{
  "anonymous": false,
  "inputs": [
    {
      "indexed": false,
      "internalType": "uint256",
      "name": "newCount",
      "type": "uint256"
    }
  ],
  "name": "CountIncremented",
  "type": "event"
},
{
  "anonymous": false,
  "inputs": [
    {
      "indexed": false,
      "internalType": "string",
      "name": "newMessage",
      "type": "string"
    },
    {
      "indexed": false,
      "internalType": "address",
      "name": "updatedBy",
      "type": "address"
    }
  ],
  "name": "MessageUpdated",
  "type": "event"
}
```

#### 4. äº‹ä»¶æ ¼å¼åŒ–å·¥å…·å‡½æ•°
**æ–‡ä»¶**: `src/app/components/ContractEvents.tsx`

```typescript
// æ ¼å¼åŒ–æ—¶é—´æˆ³
const formatTimestamp = (timestamp: string) => {
  const date = new Date(Number(timestamp) * 1000)
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

// æˆªæ–­åœ°å€æ˜¾ç¤º
const truncateAddress = (address: string) => {
  return `${address.slice(0, 6)}...${address.slice(-4)}`
}

// æˆªæ–­äº¤æ˜“å“ˆå¸Œæ˜¾ç¤º
const truncateHash = (hash: string) => {
  return `${hash.slice(0, 10)}...${hash.slice(-8)}`
}
```

---

## æ€»ç»“

è¿™ä¸ª EtherFlow é¡¹ç›®å±•ç¤ºäº†å®Œæ•´çš„ Web3 åº”ç”¨å¼€å‘æ¨¡å¼ï¼ŒåŒ…å«äº†ï¼š

### é’±åŒ…äº¤äº’åŠŸèƒ½
- **å¤šç§è¿æ¥æ–¹å¼**: Wagmiã€åŸç”Ÿ MetaMaskã€Ethers.js
- **ENS æ”¯æŒ**: åç§°è§£æå’Œå¤´åƒè·å–
- **ç½‘ç»œç®¡ç†**: å¤šé“¾æ”¯æŒå’Œç½‘ç»œåˆ‡æ¢
- **è½¬è´¦åŠŸèƒ½**: å®Œæ•´çš„è½¬è´¦æµç¨‹å’Œä½™é¢ç®¡ç†
- **äº¤æ˜“æŸ¥è¯¢**: è¯¦ç»†çš„äº¤æ˜“ä¿¡æ¯è·å–

### åˆçº¦äº¤äº’åŠŸèƒ½
- **çŠ¶æ€è¯»å–**: å¤šç§æ–¹å¼è¯»å–åˆçº¦å˜é‡
- **äº‹ä»¶ç›‘å¬**: é€šè¿‡ The Graph æŸ¥è¯¢åˆçº¦äº‹ä»¶
- **åˆçº¦è°ƒç”¨**: æ”¯æŒè¯»å–å’Œå†™å…¥æ“ä½œ

### æŠ€æœ¯ç‰¹ç‚¹
- **TypeScript**: å®Œæ•´çš„ç±»å‹å®‰å…¨
- **ç°ä»£åŒ– UI**: Uniswap é£æ ¼çš„è®¾è®¡
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **å“åº”å¼è®¾è®¡**: æ”¯æŒç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
- **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ lodash è¿›è¡Œé˜²æŠ–å¤„ç†

è¿™ä¸ªé¡¹ç›®ä¸º Web3 åº”ç”¨å¼€å‘æä¾›äº†å®Œæ•´çš„å‚è€ƒå®ç°ã€‚
